# Order By 절



## 1. ORDER BY 정렬

ORDER BY 절은 SQL 문장으로 조회된 데이터들을 다양한 목적에 맞게 특정 칼럼을 기준으로 정렬하여 출력하는데 사용한다. ORDER BY 절에 칼럼(Column)명 대신에 SELECT 절에서 사용한 ALIAS 명이나 칼럼 순서를 나타내는 정수도 사용 가능하다. 그리고 별도로 정렬 방식을 지정하지 않으면 기본적으로 오름차순이 적용되며, SQL 문장의 제일 마지막에 위치한다.

```sql
SELECT 칼럼명 [ALIAS명] 
FROM 테이블명 
[WHERE 조건식] 
[GROUP BY 칼럼(Column)이나 표현식] 
[HAVING 그룹조건식] 
[ORDER BY 칼럼(Column)이나 표현식 [ASC 또는 DESC]] ;
```

- ASC(Ascending) : 오름차순으로 정렬한다.(기본 값이므로 생략 가능) 

- DESC(Descending) : 내림차순으로 정렬한다.



## 2. SELECT 문장 실행 순서

GROUP BY 절과 ORDER BY가 같이 사용될 때 SELECT 문장은 6개의 절로 구성이 되고, SELECT 문장의 수행 단계는 아래와 같다.

⑤SELECT 칼럼명 [ALIAS명] 

①FROM 테이블명 

②WHERE 조건식 

③GROUP BY 칼럼(Column)이나 표현식 

④HAVING 그룹조건식 

⑥ORDER BY 칼럼(Column)이나 표현식;



위 순서는 옵티마이저가 SQL 문장의 SYNTAX, SEMANTIC 에러를 점검하는 순서이기도 하다. 예를 들면 FROM 절에 정의되지 않은 테이블의 칼럼을 WHERE 절, GROUP BY 절, HAVING 절, SELECT 절, ORDER BY 절에서 사용하면 에러가 발생한다. **그러나 ORDER BY 절에는 SELECT 목록에 나타나지 않은 문자형 항목이 포함될 수 있다. 단, SELECT DISTINCT를 지정하거나 SQL 문장에 GROUP BY 절이 있거나 또는 SELECT 문에 UNION 연산자가 있으면 열 정의가 SELECT 목록에 표시되어야 한다.** 이 부분은 관계형 데이터베이스가 데이터를 메모리에 올릴 때 행 단위로 모든 칼럼을 가져오게 되므로, SELECT 절에서 일부 칼럼만 선택하더라도 ORDER BY 절에서 메모리에 올라와 있는 다른 칼럼의 데이터를 사용할 수 있다.

```sql
[예제] SELECT 절에 없는 EMP 칼럼을 ORDER BY 절에 사용한다.

SELECT EMPNO, ENAME 
FROM EMP 
ORDER BY MGR;
```



```sql
[예제] 인라인 뷰에 정의된 SELECT 칼럼을 메인쿼리에서 사용한다.

SELECT EMPNO 
FROM (SELECT EMPNO, ENAME 
      FROM EMP 
      ORDER BY MGR);
```

실행 결과에서 2장에서 배울 인라인 뷰의 SELECT 절에서 정의한 칼럼은 메인쿼리에서도 사용할 수 있는 것을 확인할 수 있다.



```sql
[예제] 인라인 뷰에 미정의된 칼럼을 메인쿼리에서 사용해본다.

SELECT MGR 
FROM (SELECT EMPNO, ENAME 
      FROM EMP 
      ORDER BY MGR); 
      
SELECT MGR FROM ; * ERROR: "MGR": 부적합한 식별자
```

그러나 서브쿼리의 SELECT 절에서 선택되지 않은 칼럼들은 계속 유지되는 것이 아니라 서브쿼리 범위를 벗어나면 더 이상 사용할 수 없게 된다. (인라인 뷰도 동일함) GROUP BY 절에서 그룹핑 기준을 정의하게 되면 데이터베이스는 일반적인 SELECT 문장처럼 FROM 절에 정의된 테이블의 구조를 그대로 가지고 가는 것이 아니라, GROUP BY 절의 그룹핑 기준에 사용된 칼럼과 집계 함수에 사용될 수 있는 숫자형 데이터 칼럼들의 집합을 새로 만든다. GROUP BY 절을 사용하게 되면 그룹핑 기준에 사용된 칼럼과 집계 함수에 사용될 수 있는 숫자형 데이터 칼럼들의 집합을 새로 만드는데, 개별 데이터는 필요 없으므로 저장하지 않는다. GROUP BY 이후 수행 절인 SELECT 절이나 ORDER BY 절에서 개별 데이터를 사용하는 경우 에러가 발생한다. **결과적으로 SELECT 절에서는 그룹핑 기준과 숫자 형식 칼럼의 집계 함수를 사용할 수 있지만, 그룹핑 기준 외의 문자 형식 칼럼은 정할 수 없다.**

```sql
[예제] GROUP BY 절 사용시 SELECT 절에 일반 칼럼을 사용해본다.

SELECT JOB, SAL 
FROM EMP 
GROUP BY JOB 
HAVING COUNT(*) > 0 
ORDER BY SAL; 

SELECT JOB, SAL ; * ERROR: GROUP BY 표현식이 아니다.
```



```sql
[예제] GROUP BY 절 사용시 ORDER BY 절에 일반 칼럼을 사용해본다.

SELECT JOB 
FROM EMP 
GROUP BY JOB 
HAVING COUNT(*) > 0 
ORDER BY SAL; 

ORDER BY SAL; * ERROR: GROUP BY 표현식이 아니다.
```



```sql
[예제] GROUP BY 절 사용시 ORDER BY 절에 집계 칼럼을 사용해본다.

SELECT JOB 
FROM EMP 
GROUP BY JOB 
HAVING COUNT(*) > 0 
ORDER BY MAX(EMPNO), MAX(MGR), SUM(SAL), COUNT(DEPTNO), MAX(HIREDATE);
```

SELECT SQL에서 **GROUP BY 절이 사용되었기 때문에 SELECT 절에 정의하지 않은 MAX, SUM, COUNT 집계 함수도 ORDER BY 절에서 사용할 수 있는 것을 실행 결과에서 확인할 수 있다.**



## 3. Top N 쿼리

- ROWNUM

Oracle에서 순위가 높은 N개의 로우를 추출하기 위해 ORDER BY 절과 WHERE 절의 ROWNUM 조건을 같이 사용하는 경우가 있는데 이 두 조건으로는 원하는 결과를 얻을 수 없다. Oracle의 경우 정렬이 완료된 후 데이터의 일부가 출력되는 것이 아니라, 데이터의 일부가 먼저 추출된 후(ORDER BY 절은 결과 집합을 결정하는데 관여하지 않음) 데이터에 대한 정렬 작업이 일어나므로 주의해야 한다.



```sql
[예제] 사원 테이블에서 급여가 높은 3명만 내림차순으로 출력하고자 하는데, 잘못 사용된 SQL의 사례이다.

SELECT ENAME, SAL 
FROM EMP 
WHERE ROWNUM < 4 
ORDER BY SAL DESC;
```

실행 결과의 3명은 급여가 상위인 3명을 출력한 것이 아니라, 급여 순서에 상관없이 무작위로 추출된 3명에 한해서 급여를 내림차순으로 정렬한 결과이므로 원하는 결과를 출력한 것이 아니다.

ORDER BY 절이 없으면 ORACLE의 ROWNUM 조건과 SQL SERVER의 TOP 절은 같은 결과를 보인다. 그렇지만, ORDER BY 절이 사용되는 경우 ORACLE은 ROWNUM 조건을 ORDER BY 절보다 먼저 처리되는 WHERE 절에서 처리하므로, 정렬 후 원하는 데이터를 얻기 위해서는 2장 4절에서 배울 인라인 뷰에서 먼저 데이터 정렬을 수행한 후 메인쿼리에서 ROWNUM 조건을 사용해야 한다.

```sql
SELECT ENAME, SAL 
FROM (SELECT ENAME, SAL 
      FROM EMP 
      ORDER BY SAL DESC) 
WHERE ROWNUM < 4 ;
```



- TOP ( )

반면 SQL Server는 TOP 조건을 사용하게 되면 별도 처리 없이 관련 Order By 절의 데이터 정렬 후 원하는 일부 데이터만 쉽게 출력할 수 있다.

WITH TIES 옵션은 ORDER BY 절의 조건 기준으로 TOP N의 마지막 행으로 표시되는 추가 행의 데이터가 같을 경우 N+ 동일 정렬 순서 데이터를 추가 반환하도록 지정하는 옵션이다.

```sql
[예제] 사원 테이블에서 급여가 높은 2명을 내림차순으로 출력하고자 한다.

SELECT TOP(2) ENAME, SAL 
FROM EMP 
ORDER BY SAL DESC;
2개의 행이 선택되었다.
```



```sql
[예제] 사원 테이블에서 급여가 높은 2명을 내림차순으로 출력하는데 같은 급여를 받는 사원이 있으면 같이 출력한다.

SELECT TOP(2) WITH TIES ENAME, SAL 
FROM EMP 
ORDER BY SAL DESC;
3개의 행이 선택되었다.
```

